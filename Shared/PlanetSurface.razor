@inject IJSRuntime JSRuntime
@inject SpaceBlazor.Services.GameState State

<div class="planet-surface">
    <!-- Header -->
    <div class="city-header">
        <h1>@PlanetName Port Authority</h1>
        <p>Welcome, Traveler.</p>
    </div>

    <!-- Background Image is set via CSS class or inline style -->
    
    <!-- Menu Grid -->
    <div class="city-menu">
        <div class="menu-card" @onclick="ShowTavern">
            <h3>üç∫ The Rusty Airlock</h3>
            <p>Gather intel and relax.</p>
        </div>

        <div class="menu-card" @onclick="ShowMarket">
            <h3>üì¶ Exchange</h3>
            <p>Trade commodities.</p>
        </div>

        <div class="menu-card" @onclick="ShowGuild">
            <h3>‚öîÔ∏è Mercenary Guild</h3>
            <p>Bounties and contracts.</p>
        </div>

        <div class="menu-card launch-btn" @onclick="Launch">
            <h3>üöÄ Launch</h3>
            <p>Return to orbit.</p>
        </div>
    </div>

    <!-- Active Panel Overlay -->
    @if (activePanel != null)
    {
        <div class="city-panel-overlay">
            <div class="city-panel">
                <button class="close-btn" @onclick="ClosePanel">X</button>
                @if (activePanel == "Tavern")
                {
                    <h2>The Rusty Airlock</h2>
                    <p class="flavor-text">"@flavorText"</p>
                    <button class="btn-action" @onclick="GenerateGossip">Buy a round (50cr)</button>
                }
                else if (activePanel == "Market")
                {
                    <h2>Commodity Exchange</h2>
                    <p>Market Terminal Offline (Integration Pending)</p>
                }
                else if (activePanel == "Guild")
                {
                    <h2>Bounty Board</h2>
                    <div class="bounty-list">
                        <div class="bounty-item">
                            <span>‚ò†Ô∏è <b>@bountyTarget</b></span>
                            <span class="reward">Reward: @bountyReward CR</span>
                        </div>
                        <p><i>Last seen in Sector @bountySector...</i></p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .planet-surface {
        position: absolute;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: url('images/spaceport_bg.png') no-repeat center center fixed;
        background-size: cover;
        z-index: 200;
        font-family: 'Orbitron', sans-serif;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .city-header {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0,0,0,0.7);
        padding: 20px;
        border-left: 5px solid cyan;
    }

    .city-menu {
        display: flex;
        gap: 20px;
    }

    .menu-card {
        width: 200px;
        height: 250px;
        background: rgba(0, 20, 40, 0.85);
        border: 2px solid #004466;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .menu-card:hover {
        background: rgba(0, 40, 80, 0.95);
        transform: translateY(-5px);
        border-color: cyan;
        box-shadow: 0 0 15px cyan;
    }
    .launch-btn {
        border-color: #ffaa00;
    }
    .launch-btn:hover {
        border-color: #ffcc00;
        box-shadow: 0 0 15px #ffcc00;
    }

    .city-panel-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .city-panel {
        width: 600px;
        background: #001122;
        border: 2px solid cyan;
        padding: 40px;
        position: relative;
    }
    .close-btn {
        position: absolute;
        top: 10px; right: 10px;
        background: none; border: 1px solid red; color: red;
        cursor: pointer;
    }
    .flavor-text {
        font-style: italic;
        color: #aaddff;
        margin: 20px 0;
    }
    .btn-action {
        background: #004466; color: white; border: none; padding: 10px 20px; cursor: pointer;
    }
    .btn-action:hover { background: cyan; color: black; }
</style>

@code {
    [Parameter] public string PlanetName { get; set; } = "Unknown World";
    [Parameter] public EventCallback OnLaunch { get; set; }

    private string activePanel = null;
    private string flavorText = "The bartender wipes a glass and nods specifically at you.";
    
    // Guild Data
    private string bountyTarget = "Red Baron";
    private int bountyReward = 5000;
    private string bountySector = "Alpha Centauri";

    private void ShowTavern() => activePanel = "Tavern";
    private void ShowMarket() => activePanel = "Market";
    private void ShowGuild() => activePanel = "Guild";
    private void Launch() => OnLaunch.InvokeAsync();
    
    private void ClosePanel() => activePanel = null;

    private void GenerateGossip()
    {
        var gossips = new[] {
            "I heard tech prices are skyrocketing in the Core Systems.",
            "Don't fly near the Nebula without shields.",
            "A massive hauler was seen dumping cargo near Sirius.",
            "The Guild is paying double for pirate kills today."
        };
        flavorText = gossips[new Random().Next(gossips.Length)];
        // Deduct credits? State.Credits -= 50;
    }
}

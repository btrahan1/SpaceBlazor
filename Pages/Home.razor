@page "/"
@inject SpaceBlazor.Services.GalaxyService Galaxy
@inject SpaceBlazor.Services.GameState State
@inject IJSRuntime JSRuntime
@using SpaceBlazor.Shared

<PageTitle>SpaceBlazor - The Astral Frontier</PageTitle>

<div style="position: relative; width: 100vw; height: 100vh; overflow: hidden;">
    <Hud />
    
    <!-- Docking Alert -->
    @if (canDock)
    {
        <div class="dock-alert">
            PRESS <span class="key">D</span> TO DOCK
        </div>
    }

    <!-- Control Hint -->
    <div class="control-hint">
        PRESS <span class="key">TAB</span> TO TOGGLE FLIGHT
    </div>

    <!-- Docking Menu -->
    @if (isDocked && currentStation != null)
    {
        <div class="dock-menu">
            <div class="dock-header">
                <h1>@currentStation.Name</h1>
                <span class="station-type">@currentStation.Type</span>
                <button class="btn btn-danger btn-sm" @onclick="Undock">UNDOCK</button>
            </div>

            <div class="dock-content">
                <!-- Services -->
                <div class="services-panel">
                    <h3>Services</h3>
                    <div class="service-row">
                        <span>Refuel (1cr)</span>
                        <button class="btn btn-warning btn-sm" @onclick="RefuelShip" disabled="@(State.Fuel >= State.MaxFuel || State.Credits < 10)">Fill Up</button>
                    </div>
                     <div class="service-row">
                        <span>Repair Hull (10cr)</span>
                        <button class="btn btn-success btn-sm" @onclick="RepairShip" disabled="@(State.Hull >= State.MaxHull || State.Credits < 50)">Repair All</button>
                    </div>
                </div>

                <!-- Market (Standard Stations) -->
                @if (currentStation.Type != "Shipyard")
                {
                    <div class="market-panel">
                        <h3>Commodity Market</h3>
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Cargo</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in currentStation.MarketData)
                                {
                                    <tr>
                                        <td>@item.Key</td>
                                        <td class="text-warning">@item.Value CR</td>
                                        <td>@(State.Cargo.ContainsKey(item.Key) ? State.Cargo[item.Key] : 0)</td>
                                        <td>
                                            <div class="market-actions">
                                                <button class="btn-action buy" @onclick="() => Buy(item.Key, item.Value)">BUY</button>
                                                <button class="btn-action buy-max" @onclick="() => BuyMax(item.Key, item.Value)">MAX</button>
                                                
                                                <button class="btn-action sell" @onclick="() => Sell(item.Key, (int)(item.Value * 0.8))">SELL</button>
                                                <button class="btn-action sell-max" @onclick="() => SellMax(item.Key, (int)(item.Value * 0.8))">MAX</button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <!-- Shipyard (Shipyard Only) -->
                @if (currentStation.Type == "Shipyard")
                {
                    <div class="market-panel" style="width: 500px;">
                        <h3>Shipyard Dealership</h3>
                        <div class="ship-list">
                            @foreach (var ship in SpaceBlazor.Models.ShipClass.Catalog)
                            {
                                var currentShip = State.CurrentShip; // The static def for Trade-In
                                int tradeIn = (int)(currentShip.Price * 0.5f);
                                int netCost = ship.Price - tradeIn;
                                bool canAfford = State.Credits >= netCost;
                                bool isOwned = State.CurrentShipClassId == ship.Id;

                                <div class="ship-card @(isOwned ? "owned" : "")">
                                    <div class="ship-header">
                                        <span class="ship-name">@ship.Name</span>
                                        <span class="ship-price">@(isOwned ? "OWNED" : $"{netCost:N0} CR")</span>
                                    </div>
                                    <div class="ship-stats">
                                        <div>HP: @ship.MaxHull</div>
                                        <div>Cargo: @ship.CargoCapacity</div>
                                        <div>Speed: @ship.SpeedMultiplier x</div>
                                        <div>Guns: @ship.Hardpoints</div>
                                    </div>
                                    <div class="ship-desc">@ship.Description</div>
                                    @if (!isOwned)
                                    {
                                        <button class="btn btn-primary btn-sm btn-block" disabled="@(!canAfford)" @onclick="() => PurchaseShip(ship)">
                                            PURCHASE (Trade-In: @tradeIn CR)
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Sector Map -->
    @if (showMap)
    {
        <div class="map-overlay" 
             @onwheel="OnMapWheel" @onwheel:preventDefault
             @onmousedown="OnMapMouseDown" @onmousemove="OnMapMouseMove" @onmouseup="OnMapMouseUp">
            <h1>SECTOR MAP</h1>
            <svg viewBox="@MapViewBox" width="100%" height="100%" style="pointer-events: none;">
                <!-- NOTE: pointer-events: none on SVG allows clicks to pass through to elements IF they have pointer-events: auto.
                     But we need the DIV to capture drag.
                     Actually, SVG Elements (Circles) need to be clickable. 
                     We should handle Drag on the DIV, but Click on the Circle bubbles? 
                     Yes, distinct events. -->
                <!-- Connections -->
                @foreach (var sys in Galaxy.Systems)
                {
                    foreach (var gate in sys.JumpGates)
                    {
                        var target = Galaxy.Systems.FirstOrDefault(s => s.Id == gate.TargetSystemId);
                        if (target != null)
                        {
                            int status = GetRouteStatus(sys.Id, target.Id);
                            // 3=Green, 2=Yellow, 1=Cyan, 0=Grey
                            string color = status == 3 ? "lime" : (status == 2 ? "yellow" : (status == 1 ? "cyan" : "#444"));
                            string width = status == 2 ? "5" : (status >= 1 ? "3" : "2");
                            string opacity = status > 0 ? "1" : "0.5";
                            string dash = status == 1 ? "5,5" : "none"; 

                            <line x1="@sys.Coordinates.x" y1="@sys.Coordinates.z" 
                                  x2="@target.Coordinates.x" y2="@target.Coordinates.z" 
                                  stroke="@color" 
                                  stroke-width="@width"
                                  opacity="@opacity"
                                  stroke-dasharray="@dash" />
                        }
                    }
                }

                <!-- Systems -->
                @foreach (var sys in Galaxy.Systems)
                {
                    // Determine Type Color
                    string baseColor = "white"; // Default
                    var mainStation = sys.Stations.FirstOrDefault();
                    if (mainStation != null)
                    {
                        if (mainStation.Type == "Mining Array") baseColor = "#4da6ff"; // Blue (Ore)
                        else if (mainStation.Type == "Trading Post") baseColor = "#ff8c00"; // Orange (Tech)
                    }

                    <!-- Clickable Area -->
                    <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="30" fill="transparent" 
                            style="cursor: pointer; pointer-events: all;" @onmousedown:stopPropagation @onclick="() => SelectMapSystem(sys.Id)" />

                    <!-- Visual Dot -->
                    <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="@(sys == Galaxy.CurrentSystem ? 15 : 10)" 
                            fill="@(sys == Galaxy.CurrentSystem ? "cyan" : (sys.Id == selectedMapSystemId ? "yellow" : baseColor))" 
                            opacity="0.8" style="pointer-events: none;" />
                    
                    <!-- Always show Name (Default) -->
                    @if (sys.Id != selectedMapSystemId && sys != Galaxy.CurrentSystem)
                    {
                        @((MarkupString)$"<text x='{sys.Coordinates.x}' y='{sys.Coordinates.z + 50}' fill='#ccc' text-anchor='middle' font-size='60' style='pointer-events: none; font-family: Arial;'>{sys.Name}</text>")
                    }

                    @if (sys.Id == selectedMapSystemId)
                    {
                        <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="20" fill="none" stroke="yellow" stroke-width="2" />
                        @((MarkupString)$"<text x='{sys.Coordinates.x}' y='{sys.Coordinates.z + 80}' fill='yellow' text-anchor='middle' font-size='100' font-weight='bold' style='pointer-events: none; font-family: Arial;'>{sys.Name}</text>")
                    }

                    @if (sys == Galaxy.CurrentSystem)
                    {
                         @((MarkupString)$"<text x='{sys.Coordinates.x}' y='{sys.Coordinates.z - 50}' fill='cyan' text-anchor='middle' font-size='80' font-weight='bold' style='font-family: Arial;'>YOU</text>")
                         <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="25" fill="none" stroke="cyan" stroke-width="2">
                             <animate attributeName="r" from="20" to="40" dur="1s" repeatCount="indefinite" />
                             <animate attributeName="opacity" from="1" to="0" dur="1s" repeatCount="indefinite" />
                         </circle>
                    }
                }
            </svg>
            <!-- System Info Panel -->
            @if (selectedMapSystemId != null)
            {
                var sys = Galaxy.Systems.FirstOrDefault(s => s.Id == selectedMapSystemId);
                if (sys != null)
                {
                    <div class="map-info-panel" @onmousedown:stopPropagation @onwheel:stopPropagation>
                        <h2>@sys.Name</h2>
                        <div class="info-row">
                            <span class="label">Coordinates:</span>
                            <span class="value">@((int)sys.Coordinates.x), @((int)sys.Coordinates.z)</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Planets:</span>
                            <span class="value">@sys.Planets.Count</span>
                        </div>
                        <hr/>
                        <h3>Stations & Economy</h3>
                        @if (sys.Stations.Any())
                        {
                            @foreach (var st in sys.Stations)
                            {
                                <div class="station-card">
                                    <div class="station-name">@st.Name</div>
                                    <div class="station-type">@st.Type</div>
                                    <div class="trade-hint">@GetTradeHint(st.Type)</div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">No Stations detected.</p>
                        }
                    </div>
                }
            }
            
            <div class="map-controls">
                @if (selectedMapSystemId != null && selectedMapSystemId != Galaxy.CurrentSystem.Id)
                {
                    <button class="btn btn-warning" @onclick="PlotRoute" style="margin-right: 20px; font-size: 1.2rem;">PLOT JUMP ROUTE</button>
                }
                <p>Press <span class="key">M</span> to Close</p>
            </div>
        </div>
    }

    <canvas id="renderCanvas" style="width: 100%; height: 100%; touch-action: none; outline: none;" tabindex="1"></canvas>
</div>

<style>
    /* ... existing styles ... */
    
    .map-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 5, 10, 0.95);
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden; /* Prevent scroll on zoom */
        padding: 20px;
    }
    
    .map-overlay h1 {
        color: cyan;
        margin-bottom: 10px;
        text-shadow: 0 0 10px cyan;
    }
    
    .map-info-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 300px;
        background: rgba(0, 20, 40, 0.9);
        border: 1px solid #00aaff;
        border-radius: 8px;
        padding: 15px;
        color: white;
        pointer-events: auto; /* Enable interaction */
        box-shadow: 0 0 20px rgba(0, 170, 255, 0.3);
    }
    
    .map-info-panel h2 {
        margin: 0 0 10px 0;
        color: #00aaff;
        font-size: 1.5rem;
        text-transform: uppercase;
    }
    
    .map-info-panel h3 {
        font-size: 1.1rem;
        color: #ddd;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
        margin-top: 10px;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .label { color: #888; }
    .value { font-weight: bold; }
    
    .station-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px;
        margin-top: 5px;
        border-left: 3px solid #00ffaa;
    }
    
    .station-name { font-weight: bold; color: white; }
    .station-type { font-size: 0.8rem; color: #aaa; font-style: italic; }
    .trade-hint { 
        font-size: 0.8rem; 
        color: #aaffaa; 
        margin-top: 4px; 
    }
    
    .map-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        align-items: center;
        pointer-events: auto;
        color: white;
    }
    
    .key {
        background: #333;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #666;
        font-family: monospace;
    }

    /* ... existing dock styles ... */
    .dock-menu {
        position: absolute;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 5, 10, 0.9);
        z-index: 4000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .dock-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .dock-header h1 {
        font-size: 3rem;
        color: #00ffaa;
        text-shadow: 0 0 20px #00ffaa;
        margin: 0;
    }
    
    .dock-content {
        display: flex;
        gap: 40px;
        background: rgba(0, 20, 40, 0.8);
        padding: 40px;
        border: 1px solid #00ffaa;
        border-radius: 10px;
        box-shadow: 0 0 50px rgba(0, 255, 170, 0.2);
    }
    
    .services-panel, .market-panel {
        width: 300px;
    }

    /* Shipyard Styles */
    .ship-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 500px;
        overflow-y: auto;
    }
    .ship-card {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #444;
        padding: 10px;
        border-radius: 5px;
    }
    .ship-card.owned {
        border-color: gold;
        background: rgba(255, 215, 0, 0.1);
    }
    .ship-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        margin-bottom: 5px;
        color: cyan;
    }
    .ship-price { color: lime; }
    .ship-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 5px;
    }
    .ship-desc {
        font-size: 0.8rem;
        font-style: italic;
        color: #888;
        margin-bottom: 8px;
    }
    
    .services-panel h3, .market-panel h3 {
        border-bottom: 1px solid #555;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #aaa;
    }
    
    .service-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
</style>

@code {
    private DotNetObjectReference<Home>? objRef;
    private bool canDock = false;
    private string? dockStationId;
    private bool isDocked = false;
    private bool showMap = false;

    // ... existing startup ...
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await Task.Delay(100); 
            
            await JSRuntime.InvokeVoidAsync("spaceRenderer.init", "renderCanvas");
            await JSRuntime.InvokeVoidAsync("spaceRenderer.setDotNetRef", objRef);

            // Load Initial System
            await JSRuntime.InvokeVoidAsync("spaceRenderer.loadSystem", Galaxy.CurrentSystem);
            await JSRuntime.InvokeVoidAsync("spaceRenderer.resetShip"); // [FIX] Ensure safe spawn
            await JSRuntime.InvokeVoidAsync("spaceRenderer.changeShip", State.CurrentShip.Name, State.CurrentShip.Hardpoints); // [NEW] Set Correct Ship Visuals & Stats
            
            // KEY LISTENERS (D for Dock, M for Map, Shift+T for Lazy Trade)
            await JSRuntime.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', (e) => { 
                    if (e.key.toLowerCase() === 'd') { window.spaceRenderer.dotNetRef.invokeMethodAsync('RequestDock'); }
                    if (e.key.toLowerCase() === 'm') { window.spaceRenderer.dotNetRef.invokeMethodAsync('ToggleMap'); }
                    if (e.key.toLowerCase() === 't' && e.shiftKey) { window.spaceRenderer.dotNetRef.invokeMethodAsync('LazyTrade'); }
                    if (e.key.toLowerCase() === 'y' && e.shiftKey) { window.spaceRenderer.dotNetRef.invokeMethodAsync('LazyShipyard'); }
                })
            ");
        }
    }

    [JSInvokable]
    public async Task ToggleMap()
    {
        showMap = !showMap;
        if (showMap)
        {
             await JSRuntime.InvokeVoidAsync("spaceRenderer.exitFlightMode");
        }
        StateHasChanged();
    }

    [JSInvokable]
    public async Task LazyTrade()
    {
        // 1. Find Priority Target (Trading Post)
        var station = Galaxy.CurrentSystem.Stations.FirstOrDefault(s => s.Type == "Trading Post") 
                      ?? Galaxy.CurrentSystem.Stations.FirstOrDefault();
        
        if (station != null)
        {
            Console.WriteLine($"Lazy Trade: Autopilot to {station.Name} ({station.Type})");
            // Target the Root Node
            var targetName = "stationRoot_" + station.Id;
            await JSRuntime.InvokeVoidAsync("spaceRenderer.engageAutopilotByName", targetName);
        }
        else
        {
            Console.WriteLine("Lazy Trade: No stations found in this sector.");
        }
    }

    [JSInvokable]
    public async Task LazyShipyard()
    {
        // 1. Find Shipyard
        var station = Galaxy.CurrentSystem.Stations.FirstOrDefault(s => s.Type == "Shipyard");
        
        if (station != null)
        {
            Console.WriteLine($"Lazy Shipyard: Autopilot to {station.Name}");
            var targetName = "stationRoot_" + station.Id;
            await JSRuntime.InvokeVoidAsync("spaceRenderer.engageAutopilotByName", targetName);
        }
        else
        {
            Console.WriteLine("Lazy Shipyard: No Shipyard detectable.");
        }
    }
    
    private int GetRouteStatus(string id1, string id2)
    {
        // 1. Check Active Navigation (Priority)
        if (State.IsAutoNavigating && State.NavigationRoute.Count > 0)
        {
            var stops = State.NavigationRoute.ToList();
            stops.Insert(0, Galaxy.CurrentSystem.Id); 

            for (int i = 0; i < stops.Count - 1; i++)
            {
                if (stops[i] == id1 && stops[i+1] == id2) return 2; // Active (Yellow)
            }
        }
        
        // 2. Check History (Completed)
        if (fullRoute != null && fullRoute.Count > 0)
        {
             for (int i = 0; i < fullRoute.Count - 1; i++)
            {
                if (fullRoute[i] == id1 && fullRoute[i+1] == id2) return 3; // Completed (Green)
            }
        }

        // 3. Check Preview
        if (previewRoute != null && previewRoute.Count > 0)
        {
             for (int i = 0; i < previewRoute.Count - 1; i++)
            {
                if (previewRoute[i] == id1 && previewRoute[i+1] == id2) return 1; // Preview (Cyan)
            }
        }

        return 0; // None
    }
    
    // --- Map Zoom & Pan ---
    private double mapX = -1500;
    private double mapY = -1500;
    private double mapWidth = 3000;
    private double mapHeight = 3000;
    private bool isDraggingMap = false;
    private double lastMouseX, lastMouseY;

    private string MapViewBox => $"{mapX} {mapY} {mapWidth} {mapHeight}";

    private void OnMapWheel(WheelEventArgs e)
    {
        double zoomFactor = 1.1;
        if (e.DeltaY > 0) // Zoom Out
        {
            mapWidth *= zoomFactor;
            mapHeight *= zoomFactor;
            mapX -= (mapWidth - (mapWidth / zoomFactor)) / 2;
            mapY -= (mapHeight - (mapHeight / zoomFactor)) / 2;
        }
        else // Zoom In
        {
            mapWidth /= zoomFactor;
            mapHeight /= zoomFactor;
            mapX += (mapWidth * (zoomFactor - 1)) / 2;
            mapY += (mapHeight * (zoomFactor - 1)) / 2;
        }
    }

    private void OnMapMouseDown(MouseEventArgs e)
    {
        isDraggingMap = true;
        lastMouseX = e.ClientX;
        lastMouseY = e.ClientY;
    }

    private void OnMapMouseMove(MouseEventArgs e)
    {
        if (isDraggingMap)
        {
            double dx = e.ClientX - lastMouseX;
            double dy = e.ClientY - lastMouseY;
            
            // Scale drag by zoom level
            double scale = mapWidth / 1000.0; // Assume 1000px screen width approx
            
            mapX -= dx * scale;
            mapY -= dy * scale;

            lastMouseX = e.ClientX;
            lastMouseY = e.ClientY;
        }
    }

    private void OnMapMouseUp(MouseEventArgs e) => isDraggingMap = false;

    // --- Auto Navigation ---
    private string? selectedMapSystemId;
    private List<string> previewRoute = new();
    private List<string> fullRoute = new(); 

    private void SelectMapSystem(string sysId)
    {
        selectedMapSystemId = sysId;
        previewRoute = Galaxy.GetRoute(Galaxy.CurrentSystem.Id, sysId); 
        StateHasChanged();
    }

    private async Task PlotRoute()
    {
        if (selectedMapSystemId == null) return;
        var route = Galaxy.GetRoute(Galaxy.CurrentSystem.Id, selectedMapSystemId);
        if (route.Any())
        {
            // [NEW] Store full route for history visualization
            fullRoute = new List<string>(route);
            
            // Route contains full path including start. We need the sequence of *next* systems.
            if (route[0] == Galaxy.CurrentSystem.Id) route.RemoveAt(0);
            
            State.NavigationRoute = new Queue<string>(route);
            State.IsAutoNavigating = true;
            // showMap = false; // [FIX] Keep map open to see the route
            previewRoute.Clear(); // Clear preview, now it's active
            StateHasChanged();
            
            // [NEW] Unlock cursor so user can click things
            await JSRuntime.InvokeVoidAsync("spaceRenderer.exitFlightMode");

            ProcessNextAutoNavStep();
        }
    }
    
    private async void ProcessNextAutoNavStep()
    {
        if (!State.IsAutoNavigating || State.NavigationRoute.Count == 0)
        {
            State.IsAutoNavigating = false;
            return;
        }

        var nextSystemId = State.NavigationRoute.Peek();
        
        // Find Gate to this system
        var gate = Galaxy.CurrentSystem.JumpGates.FirstOrDefault(g => g.TargetSystemId == nextSystemId);
        if (gate != null)
        {
             // Trigger JS to Fly to this Gate
             // We need to find the JS mesh name. 
             // In spaceRenderer, gates are named "gateRoot_[TargetSystemId]" (Node) and "gate_[TargetSystemId]" (Mesh)
             // getMeshByName only finds Meshes, so we target "gate_"
             var meshName = "gate_" + nextSystemId;
             Console.WriteLine($"AutoNav: Flying to {meshName}");
             await JSRuntime.InvokeVoidAsync("spaceRenderer.engageAutopilotByName", meshName);
        }
        else
        {
            Console.WriteLine("AutoNav Error: Gate not found!");
            State.IsAutoNavigating = false;
        }
    }
    
    [JSInvokable]
    public void CancelAutoNav()
    {
        State.IsAutoNavigating = false;
        State.NavigationRoute.Clear();
        fullRoute.Clear(); // [FIX] Clear history
        StateHasChanged();
    }

    [JSInvokable]
    public void SetDockingAvailable(bool available, string? stationId)
    {
        canDock = available;
        dockStationId = stationId;
        StateHasChanged();
    }

    private SpaceBlazor.Models.SpaceStation? currentStation;

    [JSInvokable]
    public async Task RequestDock()
    {
        if (canDock && !isDocked)
        {
            isDocked = true;
            // Find Station Data
            currentStation = Galaxy.CurrentSystem.Stations.FirstOrDefault(s => s.Id == dockStationId);
            
            // [NEW] Unlock Cursor
            await JSRuntime.InvokeVoidAsync("spaceRenderer.exitFlightMode");
            
            StateHasChanged();
        }
    }

    private void Undock()
    {
        isDocked = false;
        currentStation = null;
    }

    private void RefuelShip()
    {
        int cost = 1;
        if (State.Credits >= cost && State.Fuel < State.MaxFuel)
        {
            State.ModifyCredits(-cost);
            State.Refuel(10); // +10 Fuel
        }
    }

    private void RepairShip()
    {
        int cost = 10;
        if (State.Credits >= cost && State.Hull < State.MaxHull)
        {
             State.ModifyCredits(-cost);
             State.Repair(10); // +10 Hull
        }
    }

    [JSInvokable]
    public async Task AddBounty(int amount)
    {
        State.ModifyCredits(amount);
        // Show Toast? For now just refresh state
        StateHasChanged();
        
        // Optional: Simple console log or JS Alert via runtime
        // await JSRuntime.InvokeVoidAsync("console.log", $"Bounty Received: {amount} CR");
    }

    private void Buy(string item, int price)
    {
        if (State.Credits >= price && State.GetCargoCount() < State.CargoCapacity)
        {
             State.ModifyCredits(-price);
             State.AddCargo(item, 1);
        }
    }

    private void BuyMax(string item, int price)
    {
        // Calculate max we can afford
        int maxAfford = State.Credits / price;
        // Calculate max space left
        int maxSpace = State.CargoCapacity - State.GetCargoCount();
        
        // Take the smaller limit
        int amount = Math.Min(maxAfford, maxSpace);
        
        if (amount > 0)
        {
            State.ModifyCredits(-(amount * price));
            State.AddCargo(item, amount);
        }
    }

    private void Sell(string item, int price)
    {
        if (State.Cargo.ContainsKey(item) && State.Cargo[item] > 0)
        {
             State.ModifyCredits(price);
             State.RemoveCargo(item, 1);
        }
    }

    private void SellMax(string item, int price)
    {
        if (State.Cargo.ContainsKey(item) && State.Cargo[item] > 0)
        {
            int amount = State.Cargo[item];
            State.ModifyCredits(amount * price);
            State.RemoveCargo(item, amount);
        }
    }

    private async Task PurchaseShip(SpaceBlazor.Models.ShipClass ship)
    {
        // 1. Calculate Trade-In Value (50% of current ship price)
        var currentShip = State.CurrentShip; // Refers to the definition
        int tradeIn = (int)(currentShip.Price * 0.5f);
        
        // 2. Net Cost
        int netCost = ship.Price - tradeIn;
        
        // 3. Purchase
        if (State.Credits >= netCost)
        {
            State.ModifyCredits(-netCost);
            State.BuyShip(ship);
            await JSRuntime.InvokeVoidAsync("spaceRenderer.changeShip", ship.Name, ship.Hardpoints);
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task JumpToSystem(string targetSystemId)
    {
        // 1. Update C# State
        Galaxy.JumpTo(targetSystemId);
        // AutoNav: Pop visited system
        if (State.IsAutoNavigating && State.NavigationRoute.Count > 0)
        {
            if (State.NavigationRoute.Peek() == targetSystemId)
            {
                State.NavigationRoute.Dequeue();
            }
        }
        
        StateHasChanged(); // [FIX] Update Map/HUD Forcefully

        // 2. Reload JS World
        await JSRuntime.InvokeVoidAsync("spaceRenderer.loadSystem", Galaxy.CurrentSystem);
        
        await JSRuntime.InvokeVoidAsync("spaceRenderer.resetShip");
        
        // AutoNav: Continue?
        if (State.IsAutoNavigating)
        {
            await Task.Delay(1000); // Wait for load
            ProcessNextAutoNavStep();
        }
    }

    private string GetTradeHint(string type)
    {
        if (type == "Mining Array") return "⬇ SELLS: Iron, Gold (Cheap) | ⬆ BUYS: Electronics, Medical";
        if (type == "Trading Post") return "⬇ SELLS: Electronics, Medical | ⬆ BUYS: Iron, Gold, Fuel";
        return "Standard Market";
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}

<style>
    .dock-alert {
        position: absolute;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'Consolas', monospace;
        font-size: 2rem;
        color: lime;
        text-shadow: 0 0 10px lime;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border: 2px solid lime;
        border-radius: 10px;
        animation: blink 1s infinite alternate;
        pointer-events: none;
    }

    .control-hint {
        position: absolute;
        top: 250px; /* Below HUD Status */
        left: 20px;
        font-family: 'Consolas', monospace;
        font-size: 1rem;
        color: rgba(0, 255, 0, 0.7);
        text-shadow: 0 0 5px green;
        background: rgba(0, 20, 0, 0.5);
        padding: 5px 10px;
        border: 1px solid rgba(0, 255, 0, 0.3);
        border-radius: 5px;
        pointer-events: none;
    }

    .key {
        border: 1px solid white;
        padding: 2px 6px;
        border-radius: 4px;
        color: white;
        background: rgba(255, 255, 255, 0.1);
        font-weight: bold;
    }

    .btn-action {
        width: 60px;
        padding: 5px;
        font-size: 0.8rem;
        cursor: pointer;
        background: transparent;
        color: white;
        border: 1px solid #555;
        transition: all 0.2s;
    }
    .buy { border-color: cyan; color: cyan; }
    .buy:hover { background: rgba(0, 255, 255, 0.2); }
    
    .buy-max { border-color: #008888; color: #00aaaa; width: 40px; font-size: 0.7rem; }
    .buy-max:hover { background: rgba(0, 150, 150, 0.4); color: white; }

    .sell { border-color: orange; color: orange; }
    .sell:hover { background: rgba(255, 165, 0, 0.2); }
    
    .sell-max { border-color: #aa6600; color: #cc8800; width: 40px; font-size: 0.7rem; }
    .sell-max:hover { background: rgba(180, 100, 0, 0.4); color: white; }
    
    @@keyframes blink {
        from { opacity: 0.5; box-shadow: 0 0 10px lime; }
        to { opacity: 1; box-shadow: 0 0 20px lime; }
    }
</style>

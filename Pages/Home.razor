@page "/"
@inject SpaceBlazor.Services.GalaxyService Galaxy
@inject SpaceBlazor.Services.GameState State
@inject IJSRuntime JSRuntime
@using SpaceBlazor.Shared

<PageTitle>SpaceBlazor - The Astral Frontier</PageTitle>

<div style="position: relative; width: 100vw; height: 100vh; overflow: hidden;">
    <Hud />
    
    <!-- Docking Alert -->
    @if (canDock)
    {
        <div class="dock-alert">
            PRESS <span class="key">D</span> TO DOCK
        </div>
    }

    <!-- Docking Menu -->
    @if (isDocked && currentStation != null)
    {
        <div class="dock-menu">
            <div class="dock-header">
                <h1>@currentStation.Name</h1>
                <span class="station-type">@currentStation.Type</span>
                <button class="btn btn-danger btn-sm" @onclick="Undock">UNDOCK</button>
            </div>

            <div class="dock-content">
                <!-- Services -->
                <div class="services-panel">
                    <h3>Services</h3>
                    <div class="service-row">
                        <span>Refuel (1cr)</span>
                        <button class="btn btn-warning btn-sm" @onclick="RefuelShip" disabled="@(State.Fuel >= State.MaxFuel || State.Credits < 10)">Fill Up</button>
                    </div>
                     <div class="service-row">
                        <span>Repair Hull (10cr)</span>
                        <button class="btn btn-success btn-sm" @onclick="RepairShip" disabled="@(State.Hull >= State.MaxHull || State.Credits < 50)">Repair All</button>
                    </div>
                </div>

                <!-- Market -->
                <div class="market-panel">
                    <h3>Commodity Market</h3>
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Price</th>
                                <th>Cargo</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in currentStation.MarketData)
                            {
                                <tr>
                                    <td>@item.Key</td>
                                    <td class="text-warning">@item.Value CR</td>
                                    <td>@(State.Cargo.ContainsKey(item.Key) ? State.Cargo[item.Key] : 0)</td>
                                    <td>
                                        <button class="btn btn-primary btn-xs" @onclick="() => Buy(item.Key, item.Value)">Buy</button>
                                        <button class="btn btn-success btn-xs" @onclick="() => Sell(item.Key, item.Value)">Sell</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Sector Map -->
    @if (showMap)
    {
        <div class="map-overlay" 
             @onwheel="OnMapWheel" @onwheel:preventDefault
             @onmousedown="OnMapMouseDown" @onmousemove="OnMapMouseMove" @onmouseup="OnMapMouseUp">
            <h1>SECTOR MAP</h1>
            <svg viewBox="@MapViewBox" width="100%" height="100%" style="pointer-events: none;">
                <!-- NOTE: pointer-events: none on SVG allows clicks to pass through to elements IF they have pointer-events: auto.
                     But we need the DIV to capture drag.
                     Actually, SVG Elements (Circles) need to be clickable. 
                     We should handle Drag on the DIV, but Click on the Circle bubbles? 
                     Yes, distinct events. -->
                <!-- Connections -->
                @foreach (var sys in Galaxy.Systems)
                {
                    foreach (var gate in sys.JumpGates)
                    {
                        var target = Galaxy.Systems.FirstOrDefault(s => s.Id == gate.TargetSystemId);
                        if (target != null)
                        {
                            int status = GetRouteStatus(sys.Id, target.Id);
                            // 3=Green, 2=Yellow, 1=Cyan, 0=Grey
                            string color = status == 3 ? "lime" : (status == 2 ? "yellow" : (status == 1 ? "cyan" : "#444"));
                            string width = status == 2 ? "5" : (status >= 1 ? "3" : "2");
                            string opacity = status > 0 ? "1" : "0.5";
                            string dash = status == 1 ? "5,5" : "none"; 

                            <line x1="@sys.Coordinates.x" y1="@sys.Coordinates.z" 
                                  x2="@target.Coordinates.x" y2="@target.Coordinates.z" 
                                  stroke="@color" 
                                  stroke-width="@width"
                                  opacity="@opacity"
                                  stroke-dasharray="@dash" />
                        }
                    }
                }

                <!-- Systems -->
                @foreach (var sys in Galaxy.Systems)
                {
                    <!-- Clickable Area -->
                    <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="30" fill="transparent" 
                            style="cursor: pointer; pointer-events: all;" @onmousedown:stopPropagation @onclick="() => SelectMapSystem(sys.Id)" />

                    <!-- Visual Dot -->
                    <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="@(sys == Galaxy.CurrentSystem ? 15 : 10)" 
                            fill="@(sys == Galaxy.CurrentSystem ? "cyan" : (sys.Id == selectedMapSystemId ? "yellow" : "white"))" 
                            opacity="0.8" style="pointer-events: none;" />
                    
                    <!-- Always show Name (Default) -->
                    @if (sys.Id != selectedMapSystemId && sys != Galaxy.CurrentSystem)
                    {
                        @((MarkupString)$"<text x='{sys.Coordinates.x}' y='{sys.Coordinates.z + 50}' fill='#ccc' text-anchor='middle' font-size='60' style='pointer-events: none; font-family: Arial;'>{sys.Name}</text>")
                    }

                    @if (sys.Id == selectedMapSystemId)
                    {
                        <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="20" fill="none" stroke="yellow" stroke-width="2" />
                        @((MarkupString)$"<text x='{sys.Coordinates.x}' y='{sys.Coordinates.z + 80}' fill='yellow' text-anchor='middle' font-size='100' font-weight='bold' style='pointer-events: none; font-family: Arial;'>{sys.Name}</text>")
                    }

                    @if (sys == Galaxy.CurrentSystem)
                    {
                         @((MarkupString)$"<text x='{sys.Coordinates.x}' y='{sys.Coordinates.z - 50}' fill='cyan' text-anchor='middle' font-size='80' font-weight='bold' style='font-family: Arial;'>YOU</text>")
                         <circle cx="@sys.Coordinates.x" cy="@sys.Coordinates.z" r="25" fill="none" stroke="cyan" stroke-width="2">
                             <animate attributeName="r" from="20" to="40" dur="1s" repeatCount="indefinite" />
                             <animate attributeName="opacity" from="1" to="0" dur="1s" repeatCount="indefinite" />
                         </circle>
                    }
                }
            </svg>
            <!-- System Info Panel -->
            @if (selectedMapSystemId != null)
            {
                var sys = Galaxy.Systems.FirstOrDefault(s => s.Id == selectedMapSystemId);
                if (sys != null)
                {
                    <div class="map-info-panel" @onmousedown:stopPropagation @onwheel:stopPropagation>
                        <h2>@sys.Name</h2>
                        <div class="info-row">
                            <span class="label">Coordinates:</span>
                            <span class="value">@((int)sys.Coordinates.x), @((int)sys.Coordinates.z)</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Planets:</span>
                            <span class="value">@sys.Planets.Count</span>
                        </div>
                        <hr/>
                        <h3>Stations & Economy</h3>
                        @if (sys.Stations.Any())
                        {
                            @foreach (var st in sys.Stations)
                            {
                                <div class="station-card">
                                    <div class="station-name">@st.Name</div>
                                    <div class="station-type">@st.Type</div>
                                    <div class="trade-hint">@GetTradeHint(st.Type)</div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">No Stations detected.</p>
                        }
                    </div>
                }
            }
            
            <div class="map-controls">
                @if (selectedMapSystemId != null && selectedMapSystemId != Galaxy.CurrentSystem.Id)
                {
                    <button class="btn btn-warning" @onclick="PlotRoute" style="margin-right: 20px; font-size: 1.2rem;">PLOT JUMP ROUTE</button>
                }
                <p>Press <span class="key">M</span> to Close</p>
            </div>
        </div>
    }

    <canvas id="renderCanvas" style="width: 100%; height: 100%; touch-action: none; outline: none;" tabindex="1"></canvas>
</div>

<style>
    /* ... existing styles ... */
    
    .map-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 5, 10, 0.95);
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden; /* Prevent scroll on zoom */
        padding: 20px;
    }
    
    .map-overlay h1 {
        color: cyan;
        margin-bottom: 10px;
        text-shadow: 0 0 10px cyan;
    }
    
    .map-info-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 300px;
        background: rgba(0, 20, 40, 0.9);
        border: 1px solid #00aaff;
        border-radius: 8px;
        padding: 15px;
        color: white;
        pointer-events: auto; /* Enable interaction */
        box-shadow: 0 0 20px rgba(0, 170, 255, 0.3);
    }
    
    .map-info-panel h2 {
        margin: 0 0 10px 0;
        color: #00aaff;
        font-size: 1.5rem;
        text-transform: uppercase;
    }
    
    .map-info-panel h3 {
        font-size: 1.1rem;
        color: #ddd;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
        margin-top: 10px;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .label { color: #888; }
    .value { font-weight: bold; }
    
    .station-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px;
        margin-top: 5px;
        border-left: 3px solid #00ffaa;
    }
    
    .station-name { font-weight: bold; color: white; }
    .station-type { font-size: 0.8rem; color: #aaa; font-style: italic; }
    .trade-hint { 
        font-size: 0.8rem; 
        color: #aaffaa; 
        margin-top: 4px; 
    }
    
    .map-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        align-items: center;
        pointer-events: auto;
        color: white;
    }
    
    .key {
        background: #333;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #666;
        font-family: monospace;
    }

    /* ... existing dock styles ... */
    .dock-menu {
        position: absolute;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 5, 10, 0.9);
        z-index: 4000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .dock-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .dock-header h1 {
        font-size: 3rem;
        color: #00ffaa;
        text-shadow: 0 0 20px #00ffaa;
        margin: 0;
    }
    
    .dock-content {
        display: flex;
        gap: 40px;
        background: rgba(0, 20, 40, 0.8);
        padding: 40px;
        border: 1px solid #00ffaa;
        border-radius: 10px;
        box-shadow: 0 0 50px rgba(0, 255, 170, 0.2);
    }
    
    .services-panel, .market-panel {
        width: 300px;
    }
    
    .services-panel h3, .market-panel h3 {
        border-bottom: 1px solid #555;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #aaa;
    }
    
    .service-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
</style>

@code {
    private DotNetObjectReference<Home>? objRef;
    private bool canDock = false;
    private string? dockStationId;
    private bool isDocked = false;
    private bool showMap = false;

    // ... existing startup ...
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await Task.Delay(100); 
            
            await JSRuntime.InvokeVoidAsync("spaceRenderer.init", "renderCanvas");
            await JSRuntime.InvokeVoidAsync("spaceRenderer.setDotNetRef", objRef);

            // Load Initial System
            await JSRuntime.InvokeVoidAsync("spaceRenderer.loadSystem", Galaxy.CurrentSystem);
            await JSRuntime.InvokeVoidAsync("spaceRenderer.resetShip"); // [FIX] Ensure safe spawn
            
            // KEY LISTENERS (D for Dock, M for Map)
            await JSRuntime.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', (e) => { 
                    if (e.key.toLowerCase() === 'd') { window.spaceRenderer.dotNetRef.invokeMethodAsync('RequestDock'); }
                    if (e.key.toLowerCase() === 'm') { window.spaceRenderer.dotNetRef.invokeMethodAsync('ToggleMap'); }
                })
            ");
        }
    }

    [JSInvokable]
    public void ToggleMap()
    {
        showMap = !showMap;
        StateHasChanged();
    }
    
    private int GetRouteStatus(string id1, string id2)
    {
        // 1. Check Active Navigation (Priority)
        if (State.IsAutoNavigating && State.NavigationRoute.Count > 0)
        {
            var stops = State.NavigationRoute.ToList();
            stops.Insert(0, Galaxy.CurrentSystem.Id); 

            for (int i = 0; i < stops.Count - 1; i++)
            {
                if (stops[i] == id1 && stops[i+1] == id2) return 2; // Active (Yellow)
            }
        }
        
        // 2. Check History (Completed)
        if (fullRoute != null && fullRoute.Count > 0)
        {
             for (int i = 0; i < fullRoute.Count - 1; i++)
            {
                if (fullRoute[i] == id1 && fullRoute[i+1] == id2) return 3; // Completed (Green)
            }
        }

        // 3. Check Preview
        if (previewRoute != null && previewRoute.Count > 0)
        {
             for (int i = 0; i < previewRoute.Count - 1; i++)
            {
                if (previewRoute[i] == id1 && previewRoute[i+1] == id2) return 1; // Preview (Cyan)
            }
        }

        return 0; // None
    }
    
    // --- Map Zoom & Pan ---
    private double mapX = -1500;
    private double mapY = -1500;
    private double mapWidth = 3000;
    private double mapHeight = 3000;
    private bool isDraggingMap = false;
    private double lastMouseX, lastMouseY;

    private string MapViewBox => $"{mapX} {mapY} {mapWidth} {mapHeight}";

    private void OnMapWheel(WheelEventArgs e)
    {
        double zoomFactor = 1.1;
        if (e.DeltaY > 0) // Zoom Out
        {
            mapWidth *= zoomFactor;
            mapHeight *= zoomFactor;
            mapX -= (mapWidth - (mapWidth / zoomFactor)) / 2;
            mapY -= (mapHeight - (mapHeight / zoomFactor)) / 2;
        }
        else // Zoom In
        {
            mapWidth /= zoomFactor;
            mapHeight /= zoomFactor;
            mapX += (mapWidth * (zoomFactor - 1)) / 2;
            mapY += (mapHeight * (zoomFactor - 1)) / 2;
        }
    }

    private void OnMapMouseDown(MouseEventArgs e)
    {
        isDraggingMap = true;
        lastMouseX = e.ClientX;
        lastMouseY = e.ClientY;
    }

    private void OnMapMouseMove(MouseEventArgs e)
    {
        if (isDraggingMap)
        {
            double dx = e.ClientX - lastMouseX;
            double dy = e.ClientY - lastMouseY;
            
            // Scale drag by zoom level
            double scale = mapWidth / 1000.0; // Assume 1000px screen width approx
            
            mapX -= dx * scale;
            mapY -= dy * scale;

            lastMouseX = e.ClientX;
            lastMouseY = e.ClientY;
        }
    }

    private void OnMapMouseUp(MouseEventArgs e) => isDraggingMap = false;

    // --- Auto Navigation ---
    private string? selectedMapSystemId;
    private List<string> previewRoute = new();
    private List<string> fullRoute = new(); 

    private void SelectMapSystem(string sysId)
    {
        selectedMapSystemId = sysId;
        previewRoute = Galaxy.GetRoute(Galaxy.CurrentSystem.Id, sysId); 
        StateHasChanged();
    }

    private void PlotRoute()
    {
        if (selectedMapSystemId == null) return;
        var route = Galaxy.GetRoute(Galaxy.CurrentSystem.Id, selectedMapSystemId);
        if (route.Any())
        {
            // [NEW] Store full route for history visualization
            fullRoute = new List<string>(route);
            
            // Route contains full path including start. We need the sequence of *next* systems.
            if (route[0] == Galaxy.CurrentSystem.Id) route.RemoveAt(0);
            
            State.NavigationRoute = new Queue<string>(route);
            State.IsAutoNavigating = true;
            // showMap = false; // [FIX] Keep map open to see the route
            previewRoute.Clear(); // Clear preview, now it's active
            StateHasChanged();
            
            ProcessNextAutoNavStep();
        }
    }
    
    private async void ProcessNextAutoNavStep()
    {
        if (!State.IsAutoNavigating || State.NavigationRoute.Count == 0)
        {
            State.IsAutoNavigating = false;
            return;
        }

        var nextSystemId = State.NavigationRoute.Peek();
        
        // Find Gate to this system
        var gate = Galaxy.CurrentSystem.JumpGates.FirstOrDefault(g => g.TargetSystemId == nextSystemId);
        if (gate != null)
        {
             // Trigger JS to Fly to this Gate
             // We need to find the JS mesh name. 
             // In spaceRenderer, gates are named "gateRoot_[TargetSystemId]" (Node) and "gate_[TargetSystemId]" (Mesh)
             // getMeshByName only finds Meshes, so we target "gate_"
             var meshName = "gate_" + nextSystemId;
             Console.WriteLine($"AutoNav: Flying to {meshName}");
             await JSRuntime.InvokeVoidAsync("spaceRenderer.engageAutopilotByName", meshName);
        }
        else
        {
            Console.WriteLine("AutoNav Error: Gate not found!");
            State.IsAutoNavigating = false;
        }
    }
    
    [JSInvokable]
    public void CancelAutoNav()
    {
        State.IsAutoNavigating = false;
        State.NavigationRoute.Clear();
        fullRoute.Clear(); // [FIX] Clear history
        StateHasChanged();
    }

    [JSInvokable]
    public void SetDockingAvailable(bool available, string? stationId)
    {
        canDock = available;
        dockStationId = stationId;
        StateHasChanged();
    }

    private SpaceBlazor.Models.SpaceStation? currentStation;

    [JSInvokable]
    public void RequestDock()
    {
        if (canDock && !isDocked)
        {
            isDocked = true;
            // Find Station Data
            currentStation = Galaxy.CurrentSystem.Stations.FirstOrDefault(s => s.Id == dockStationId);
            StateHasChanged();
        }
    }

    private void Undock()
    {
        isDocked = false;
        currentStation = null;
    }

    private void RefuelShip()
    {
        int cost = 1;
        if (State.Credits >= cost && State.Fuel < State.MaxFuel)
        {
            State.ModifyCredits(-cost);
            State.Refuel(10); // +10 Fuel
        }
    }

    private void RepairShip()
    {
        int cost = 10;
        if (State.Credits >= cost && State.Hull < State.MaxHull)
        {
             State.ModifyCredits(-cost);
             State.Repair(10); // +10 Hull
        }
    }

    private void Buy(string item, int price)
    {
        if (State.Credits >= price && State.GetCargoCount() < State.CargoCapacity)
        {
             State.ModifyCredits(-price);
             State.AddCargo(item, 1);
        }
    }

    private void Sell(string item, int price)
    {
        if (State.Cargo.ContainsKey(item) && State.Cargo[item] > 0)
        {
             State.ModifyCredits(price);
             State.RemoveCargo(item, 1);
        }
    }

    [JSInvokable]
    public async Task JumpToSystem(string targetSystemId)
    {
        // 1. Update C# State
        Galaxy.JumpTo(targetSystemId);
        // AutoNav: Pop visited system
        if (State.IsAutoNavigating && State.NavigationRoute.Count > 0)
        {
            if (State.NavigationRoute.Peek() == targetSystemId)
            {
                State.NavigationRoute.Dequeue();
            }
        }
        
        StateHasChanged(); // [FIX] Update Map/HUD Forcefully

        // 2. Reload JS World
        await JSRuntime.InvokeVoidAsync("spaceRenderer.loadSystem", Galaxy.CurrentSystem);
        
        await JSRuntime.InvokeVoidAsync("spaceRenderer.resetShip");
        
        // AutoNav: Continue?
        if (State.IsAutoNavigating)
        {
            await Task.Delay(1000); // Wait for load
            ProcessNextAutoNavStep();
        }
    }

    private string GetTradeHint(string type)
    {
        if (type == "Mining Array") return "⬇ SELL: Iron, Gold (Cheap) | ⬆ BUY: Electronics, Medical";
        if (type == "Trading Post") return "⬇ SELL: Electronics, Medical | ⬆ BUY: Iron, Gold, Fuel";
        return "Standard Market";
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
